!function(){"use strict";function e(e,t){this.url=e,this.avail_cb=t,this.state={},this.state.avail=!1,this.state.avail_comp={},this.selectFile(),this.probeStart()}e.prototype.probeStart=function(){if(!this.state.probeTimer){var e=setInterval(this.probeDo.bind(this),1e4);this.state.probeTimer=e,this.probeDo()}},e.prototype.probeStop=function(){this.state.probeTimer&&(clearInterval(this.state.probeTimer),delete this.state.probeTimer,this.state.probe&&this.state.probe.abort())},e.prototype.setAvail=function(e,t,a){var i;for(var o in this.state.avail_comp[e]={name:e,state:t,reason:a},this.state.avail_comp)if(!this.state.avail_comp[o].state){i=this.state.avail_comp[o];break}i?(this.state.avail=!1,this.avail_cb(i.state,i.name,i.reason)):this.state.avail||i||(this.state.avail=!0,this.avail_cb(!0))},e.prototype.getAvailComp=function(e){return void 0===e?this.state.avail_comp:this.state.avail_comp[e]},e.prototype.probeDo=function(){this.state.probe&&(this.setAvail("remote",!1,"Timeout connecting to remote, retrying..."),this.state.probe.abort());var e=new XMLHttpRequest;this.state.probe=e;var t=this;e.open("HEAD",this.url,!0),e.onload=function(e){switch(delete t.state.probe,e.target.status){case 204:t.setAvail("remote",!0,"Remote accepts OTA");break;case 403:t.setAvail("remote",!1,"Access denied, insufficient permission");break;case 404:t.setAvail("remote",!1,"Bad remote location (check OTA configuration)");break;case 409:t.setAvail("remote",!1,"Another OTA already in progress");break;default:t.setAvail("remote",!1,"Unrecognized status ("+e.target.status+")")}},e.onerror=function(e){delete t.state.probe,t.setAvail("remote",!1,"Error - "+(e.error||"Unable to connect to remote"))},e.onabort=function(e){delete t.state.probe,t.setAvail("remote",!1,"Connection to remote aborted")},e.send()},e.prototype.selectFile=function(e){e?(this.state.file=e,delete this.state.file_md5,this.calcFileHash()):(delete this.state.file,delete this.state.file_md5,this.state.file_reader&&this.state.file_reader.abort(),this.setAvail("file",!1,"No file has been selected"))},e.prototype.calcFileHash=function(){this.setAvail("file",!1,'Calculating hash for file "'+this.state.file.name+'"...'),this.state.file_reader&&this.state.file_reader.abort();var e=new FileReader;this.state.file_reader=e;var t=this,a=md5.create();e.onload=function(e){delete t.state.file_reader,t.state.file&&(a.update(e.target.result),t.state.file_md5=a.hex(),t.setAvail("file",!0,"File hash calculated"))},e.onerror=function(e){delete t.state.file_reader,t.state.file&&t.setAvail("file",!1,"Error - "+(e.error||"Unable to read the file"))},e.onabort=function(e){delete t.state.file_reader,t.state.file&&t.setAvail("file",!1,"File hashing aborted")},e.readAsArrayBuffer(this.state.file)},e.prototype.uploadDo=function(e){if(!this.state.avail)return!1;this.setAvail("upload",!1,"Upload in progress..."),this.probeStop();var t=new FormData;t.append("upload",this.state.file);var a="?length="+this.state.file.size;a+="&md5="+this.state.file_md5;var i=new XMLHttpRequest;this.state.upload=i;var o=this;return i.open("POST",this.url+a,!0),i.onload=function(t){switch(delete o.state.upload,o.setAvail("upload",!0,"Upload finished"),t.target.status){case 204:return o.selectFile(),void e(!0);case 400:e(!1,"Request rejected (network error / OTA protocol mis-matched)");break;case 403:e(!1,"Access denied, insufficient permission");break;case 404:e(!1,"Bad remote location (check OTA configuration)");break;case 409:e(!1,"Another OTA already in progress");break;case 500:e(!1,"Remote operational error - "+(t.target.responseText||"Generic failure"));break;default:e(!1,"Unrecognized status ("+t.target.status+")")}o.probeStart()},i.onerror=function(t){delete o.state.upload,o.setAvail("upload",!0,"Upload failed"),e(!1,"Error - "+(t.error||"Unable to upload to remote")),o.probeStart()},i.onabort=function(t){delete o.state.upload,o.setAvail("upload",!0,"Upload aborted"),e(!1,"Upload to remote aborted"),o.probeStart()},i.upload.onprogress=function(t){o.state.upload&&(t.lengthComputable?e(void 0,t.loaded/t.total):e(void 0,t.loaded))},i.send(t),!0},e.prototype.uploadAbort=function(){this.state.upload&&(this.state.upload.abort(),delete this.state.upload)},window.OTA=e}();